<!doctype html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
  <title>FTE Engine</title>
  <style>
    html, body {
      background-color: #000000;
      color: #808080;
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    #status {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 20px;
      color: #ffffff;
      visibility: hidden;
    }

    canvas.emscripten {
      border: 0;
      display: block;
      width: 100%;
      height: 100%;
      position: absolute;
      z-index: 1; /* Canvas fica atr√°s do joystick */
    }

    #joystick {
      position: absolute;
      bottom: 10%; /* Posiciona no canto inferior esquerdo */
      left: 10%;
      width: 120px;
      height: 120px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      z-index: 10; /* Joystick acima do canvas */
      touch-action: none;
    }

    #joystick-handle {
      position: absolute;
      width: 60px;
      height: 60px;
      background: rgba(255, 255, 255, 0.6);
      border-radius: 50%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
  </style>
</head>
<body>
  <div id="status">Loading...</div>
  <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()" tabindex="0"></canvas>
  
  <!-- Joystick elements -->
  <div id="joystick">
    <div id="joystick-handle"></div>
  </div>

  <script type="text/javascript">
    var Module = {
      files: {},
      autostart: true,
      print: function(msg) { console.log(msg); },
      printErr: function(text) { console.error(text); },
      canvas: document.getElementById('canvas'),
      setStatus: function(text) {
        var statusElement = document.getElementById('status');
        if (text) {
          statusElement.innerHTML = text;
          statusElement.style.visibility = 'visible';
        } else {
          statusElement.style.visibility = 'hidden';
        }
      },
      postRun: [
        function() {
          console.log("Engine initialized successfully.");
          Module.setStatus("");
        }
      ]
    };

    function adjustCanvasSize() {
      var canvas = document.getElementById('canvas');
      var width = window.innerWidth;
      var height = window.innerHeight;

      canvas.width = width * window.devicePixelRatio;
      canvas.height = height * window.devicePixelRatio;
      canvas.style.width = width + 'px';
      canvas.style.height = height + 'px';
    }

    window.addEventListener('resize', adjustCanvasSize);
    adjustCanvasSize();

    function begin() {
      if (Module.began) return;
      Module.began = true;
      Module.setStatus('Downloading...');

      var script = document.createElement('script');
      script.setAttribute('src', "ftewebgl.js");
      script.setAttribute('type', "text/javascript");
      script.setAttribute('charset', "utf-8");
      script.addEventListener('error', function() {
        alert("Error downloading engine script.");
        Module.setStatus("Unable to download engine JavaScript");
      }, false);
      document.head.appendChild(script);
    }

    if (Module.autostart) {
      begin();
    }

    // Joystick functionality
    const joystick = document.getElementById('joystick');
    const handle = document.getElementById('joystick-handle');
    const joystickCenter = { x: 0, y: 0 };
    const maxDistance = joystick.offsetWidth / 2 - handle.offsetWidth / 2;

    let pressedKeys = {};

    // Virtual keypress simulation
    function simulateKey(key, isPressed) {
      if (isPressed && !pressedKeys[key]) {
        pressedKeys[key] = true;
        window.dispatchEvent(new KeyboardEvent('keydown', { key }));
      } else if (!isPressed && pressedKeys[key]) {
        pressedKeys[key] = false;
        window.dispatchEvent(new KeyboardEvent('keyup', { key }));
      }
    }

    // Handle joystick movement
    function handleJoystickMovement(x, y) {
      // Map joystick positions to WASD keys
      simulateKey('w', y < -20);
      simulateKey('s', y > 20);
      simulateKey('a', x < -20);
      simulateKey('d', x > 20);

      // Map joystick positions to arrow keys
      simulateKey('ArrowUp', y < -20);
      simulateKey('ArrowDown', y > 20);
    }

    // Joystick touch/mouse events
    joystick.addEventListener('mousedown', onStart, false);
    joystick.addEventListener('touchstart', onStart, false);

    function onStart(e) {
      e.preventDefault();
      e.stopPropagation();

      const rect = joystick.getBoundingClientRect();
      joystickCenter.x = rect.left + rect.width / 2;
      joystickCenter.y = rect.top + rect.height / 2;

      const moveHandler = onMove.bind(null, e.type === 'touchstart');
      const endHandler = onEnd.bind(null, moveHandler);

      document.addEventListener(e.type === 'touchstart' ? 'touchmove' : 'mousemove', moveHandler, false);
      document.addEventListener(e.type === 'touchstart' ? 'touchend' : 'mouseup', endHandler, false);
    }

    function onMove(isTouch, e) {
      const clientX = isTouch ? e.touches[0].clientX : e.clientX;
      const clientY = isTouch ? e.touches[0].clientY : e.clientY;

      const deltaX = clientX - joystickCenter.x;
      const deltaY = clientY - joystickCenter.y;
      const distance = Math.min(maxDistance, Math.sqrt(deltaX ** 2 + deltaY ** 2));

      const angle = Math.atan2(deltaY, deltaX);
      const x = Math.cos(angle) * distance;
      const y = Math.sin(angle) * distance;

      handle.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
      handleJoystickMovement(x, y);
    }

    function onEnd(moveHandler, e) {
      e.preventDefault();
      e.stopPropagation();

      document.removeEventListener('mousemove', moveHandler, false);
      document.removeEventListener('mouseup', onEnd, false);
      document.removeEventListener('touchmove', moveHandler, false);
      document.removeEventListener('touchend', onEnd, false);

      handle.style.transform = 'translate(-50%, -50%)';
      handleJoystickMovement(0, 0); // Reset movement
    }
  </script>
</body>
</html>
